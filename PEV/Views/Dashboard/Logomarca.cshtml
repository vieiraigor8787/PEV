
@model LogomarcaModel
@{ ViewData["Title"] = "CadastroProduto";

    Layout = "_Layout_dashboard"; }


<style>
    .image-upload > input {
        display: none;
    }

    .image-upload {
        padding-top: 5px;
        border: dashed 1px;
        margin-bottom: 10px;
    }

    .img_icon {
        font-size: 32px;
    }
</style>
<hr />
<h4 class="font-weight-bold">Logomarca</h4>
<hr />


<form id="FormProduto" asp-action="SalvarLogo" asp-controller="Dashboard">

    <div class="col form-row">
        <input type="hidden" asp-for="JsonLTLogomarca">
    </div>

    <hr />
    <h5><b>Foto</b></h5>
    <hr />
    <div class="row">
        <div id="CarregaFoto" class="form-group col-md-4">
            <div  class="image-upload text-center">
                <label for="f_Foto1" class="F1"><i class="fa fa-camera img_icon"></i><div>Selecione a Imagem</div></label>
                <input id="f_Foto1" type="file" accept="image/*" name="f_Foto1" />
                <input id="txt_foto" type="hidden" />
            </div>
            <button type="button" id="btnFoto" class="btn btn-success" style="margin-top:25px;" onclick="AddIMG();">Adicionar Imagem</button>
        </div>
        <div class="form-group col-md-4"></div>
        <div>
            <table id="tb_Foto" class="table">
                <thead>
                    <tr>
                        <th>Foto Selecionada</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <hr />

    @Html.Raw(ViewData["Valida"])

    <button type="submit" class="btn btn-primary">Registrar</button>

</form>
<br />

<script src="~/js/compress.js"></script>

<script>

    var MtzFoto;
    var MtzGenero;
    var MtzSubcategoria;
    //var MtzTamanho;

    $(document).ready(function () {

        SetSubmit();
        MtzFoto = StartMTZ(MtzFoto, "JsonLTLogomarca");
        Get_Mtzs("JsonLTLogomarca", MtzFoto, "tb_Foto", "F");
        AjustarIMG('f_Foto1', 'F1', 'txt_foto');

    });


    function StartMTZ(Mtz, IdJson) {
        if ($("#" + IdJson).val() != "") {
            Mtz = JSON.parse($("#" + IdJson).val());
        }
        else {
            Mtz = [];
        }
        return Mtz;
    }

    function AddIMG() {
        var img = $("#txt_foto").val();
        AddMTZ(MtzFoto, 0, img, "JsonLTLogomarca", "tb_Foto", "F");
        $(".F1").html("<i class='fa fa-camera img_icon'></i><div>Selecione a Imagem</div>");
        $("#CarregaFoto").hide();
        $("#btnFoto").hide();
    }

    function AddMTZ(Mtz, _Codigo, _Descricao, idJson, TB, Tipo) {

        Mtz.push(
            {
                'Codigo': _Codigo,
                'Descricao': _Descricao,
            }
        );

        Get_Mtzs(idJson, Mtz, TB, Tipo);
    }

    function Get_Mtzs(idJson, Mtz, TB, Tipo) {
        $("#" + idJson).val(JSON.stringify(Mtz));
        $("#" + TB + " > tbody ").html("");
        var sHtml = "";
        for (var x = 0; x <= Mtz.length - 1; x++) {
            sHtml = "<tr>";
            if (Tipo == "F") {
                sHtml += "<td><img src='" + Mtz[x].Descricao + "'  width=60 height=40></td>";
            }
            else {
                sHtml += "<td>" + Mtz[x].Descricao + "</td>";
            }
            sHtml += "<td><a href='##' onclick='ExcluirItem(\"" + Tipo + "\",this," + x + ")'>Excluir</a></td>";
            sHtml += "</tr>";
            $("#" + TB + " > tbody ").append(sHtml);
        }
    }

    function ExcluirItem(Tipo, obj, index) {
        $(obj).closest('tr').remove();

        switch (Tipo) {

            case "F":
                delete MtzFoto[index];
                MtzFoto.splice(index, 1);
                Get_Mtzs("JsonLTLogomarca", MtzFoto, "tb_Foto", Tipo);
                break;
        }
    }

    function AjustarIMG(_upload, _preview, IdReturn) {

        const compress = new Compress()
        const preview = document.getElementById(_preview);
        const upload = document.getElementById(_upload);

        upload.addEventListener('change', (evt) => {
            $("." + _preview).html("<div class='text-center' role='alert' style='max-width:100%;height:128px;padding-top:55px;'><img src='/img/loading.gif' /> Carregando</div>");
            const files = [...evt.target.files]
            compress.compress(files, {
                size: 1, // the max size in MB, defaults to 2MB
                quality: 0.75, // the quality of the image, max is 1,
                maxWidth: 1920, // the max width of the output image, defaults to 1920px
                maxHeight: 1920, // the max height of the output image, defaults to 1920px
                resize: true // defaults to true, set false if you do not want to resize the image width and height
            }).then((images) => {


                const img = images[0]

                $("." + _preview).html("<img class='img-thumbnail' src='" + `${img.prefix}${img.data}` + "' style='max-width:100%;height:128px;' />");
                $("#" + IdReturn).val(img.prefix + img.data);

            })
        }, false)
    }


    function SetSubmit() {
        $('#FormProduto').submit(function (e) {
            e.preventDefault();
            var form = $(this);
            var url = form.attr('action');
            $.ajax({
                type: "POST",
                url: url,
                data: form.serialize(),
                success: function (data) {
                    if (data.success) {
                        alertSucesso(data.msg);
                    } else {

                        if (data.msg.indexOf("Erro") > -1) {
                            alertErro(data.msg);
                        }
                        else {
                            alertInformacao(data.msg);
                        }
                    }
                }
            });

        });
    }

</script>



